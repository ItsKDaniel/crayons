<!-- Revert this while pushing to prod -->
<!DOCTYPE html>
<html dir="ltr" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0"
    />
    <title>Form Builder</title>

    <script type="module" src="/build/crayons-custom-objects.esm.js"></script>
    <script nomodule src="/build/crayons-custom-objects.js"></script>
  </head>

  <body>
    <div
      style="
        width: 100%;
        height: 90vh;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 40px;
      "
    >
      <div
        style="
          width: 100%;
          height: auto;
          box-sizing: border-box;
          display: flex;
          justify-content: flex-end;
          padding: 0 24px;
          gap: 24px;
        "
      >
        <fw-tabs id="tabProducts">
          <fw-tab slot="tab">CONVERSATION PROPERTIES</fw-tab>
          <fw-tab slot="tab">CUSTOM OBJECTS</fw-tab>
        </fw-tabs>
      </div>
      <div
        style="
          width: 100%;
          height: 100%;
          box-sizing: border-box;
          background: #ffffff;
          border: 1px solid rgba(207, 215, 223, 0.4);
          box-shadow: 0px 4px 4px rgba(209, 209, 209, 0.4);
          border-radius: 2px;
          overflow: hidden;
        "
      >
        <fw-form-builder id="formBuilder"></fw-form-builder>
      </div>
    </div>

    <script type="application/javascript">
      var productName = 'CONVERSATION_PROPERTIES';
      var customizeWidgetFields = [];

      var formValues = {
        name: 'Company-Association-test',
        prefix: '_29',
        title: null,
        description: 'Company-Association-test',
        version: 4,
        deleted: false,
        id: 5938,
        form_options: {},
        created_time: 1659001461188,
        updated_time: 1659004708385,
        icon_link: 'https://d2lz1e868xzctj.cloudfront.net/icons/Accounts.svg',
        fields: [
          {
            id: '24a9531c-3c71-463e-9c63-8991396fde95',
            name: 'companyassociationtestname',
            label: 'Hotel Name',
            type: 'PRIMARY',
            position: 1,
            required: true,
            editable: true,
            visible: true,
            deleted: false,
            placeholder: null,
            hint: null,
            field_options: {
              _analytic: 'true',
              _primary: 'true',
              unique: 'true',
            },
            filterable: true,
            searchable: true,
            parent_id: null,
            choices: [],
          },
          {
            id: 'eea9ed82-af63-43b2-aef0-a7e8de0f8607',
            name: 'companytest',
            label: 'Location',
            type: 'RELATIONSHIP',
            position: 2,
            required: false,
            editable: true,
            visible: true,
            deleted: false,
            placeholder: null,
            hint: null,
            field_options: {
              _analytic: 'true',
              related_object_type: 'NATIVE',
              unique: 'false',
            },
            filterable: true,
            searchable: false,
            parent_id: null,
            related_entity_id: 3,
            relationship_name: 'companytest',
            child_relationship_name: 'companyassociationtest_1659004707038',
            choices: [],
          },
          {
            id: '3f2235be-b18a-443f-9944-c9ae10195e97',
            name: 'contactname',
            label: 'Booking',
            type: 'RELATIONSHIP',
            position: 3,
            required: false,
            editable: true,
            visible: true,
            deleted: false,
            placeholder: null,
            hint: null,
            field_options: {
              _analytic: 'true',
              related_object_type: 'NATIVE',
              unique: 'false',
            },
            filterable: true,
            searchable: false,
            parent_id: null,
            related_entity_id: 2,
            relationship_name: 'contactname',
            child_relationship_name: 'companyassociationtest_1659001527018',
            choices: [],
          },
        ],
      };

      var lookupTargets = [
        {
          value: 1,
          text: 'Ticket',
          isNative: true,
        },
        {
          value: 2,
          text: 'Contact',
          isNative: true,
        },
        {
          value: 4853,
          text: 'Booking ID',
          isNative: false,
        },
        {
          value: 5021,
          text: 'Native-ticket',
          isNative: false,
        },
      ];

      var formValuesConvProps = {
        docId: '34812d27-6455-4eb4-8654-cd2c4cd0ed5d',
        form_id: '0',
        bundle_id: ['555741949072343098'],
        coll_id: 'ConversationForm',
        prod_id: 'freshchat',
        organisation_id: '555741948833267800',
        name: 'Conversation Form',
        account_id: '721079537498489',
        title: 'Conversation Form',
        description: 'This is a conversation form',
        deleted: false,
        active: true,
        compressed: false,
        form_options: {
          unique_attributes: 'name, column_name, label',
        },
        version: 46,
        fields: [
          {
            id: '0395c89a-ff56-49a0-a393-79bf48d8b65c',
            name: 'group',
            column_name: 'group',
            label: 'Group',
            type: 2,
            field_options: {
              reference: 'true',
              option_value_path: 'id',
              option_label_path: 'value',
            },
            custom: false,
            editable: true,
            position: 49,
            deleted: false,
            required: false,
            visible: true,
            column_type_blob: false,
            nodegroup_skip: false,
            validatable: false,
            builder: false,
            internal: false,
            choices: [],
            fields: [],
            regex: {},
            created_at: '2023-03-14 13:20:09',
            updated_at: '2023-03-14 13:20:09',
          },
          {
            id: '4747b941-a2cf-45ef-9118-d4007826fa92',
            name: 'agent',
            column_name: 'agent',
            label: 'Agent',
            type: 2,
            field_options: {
              reference: 'true',
              option_value_path: 'id',
              option_label_path: 'value',
            },
            custom: false,
            editable: true,
            position: 50,
            deleted: false,
            required: false,
            visible: true,
            column_type_blob: false,
            nodegroup_skip: false,
            validatable: false,
            builder: false,
            internal: false,
            choices: [],
            fields: [],
            regex: {},
            created_at: '2023-03-14 13:20:09',
            updated_at: '2023-03-14 13:20:09',
          },
          {
            id: 'e189019d-ac50-4852-a17f-97acf2b05582',
            name: 'status',
            column_name: 'status',
            label: 'Status',
            type: 2,
            field_options: {
              option_value_path: 'id',
              option_label_path: 'value',
            },
            custom: false,
            editable: true,
            position: 51,
            deleted: false,
            required: false,
            visible: true,
            column_type_blob: false,
            nodegroup_skip: false,
            validatable: false,
            builder: false,
            internal: false,
            choices: [
              {
                id: '0',
                account_id: '0',
                internal_name: 'open',
                value: 'Open',
                field_id: 'e189019d-ac50-4852-a17f-97acf2b05582',
                position: 1,
              },
              {
                id: '5',
                account_id: '0',
                internal_name: 'waiting_on_customer',
                value: 'Waiting on customer',
                field_id: 'e189019d-ac50-4852-a17f-97acf2b05582',
                position: 2,
              },
              {
                id: '6',
                account_id: '0',
                internal_name: 'waiting_on_internal_teams',
                value: 'Waiting on internal teams',
                field_id: 'e189019d-ac50-4852-a17f-97acf2b05582',
                position: 3,
              },
              {
                id: '2',
                account_id: '0',
                internal_name: 'resolved',
                value: 'Resolved',
                field_id: 'e189019d-ac50-4852-a17f-97acf2b05582',
                position: 4,
              },
            ],
            fields: [],
            regex: {},
            default_value: '0',
            created_at: '2023-03-14 13:20:09',
            updated_at: '2023-03-14 13:20:09',
          },
          {
            id: '410a9452-70f4-4519-8b68-2bf0157ad46b',
            name: 'testadd',
            label: 'test_add',
            type: 1,
            required: false,
            filterable: false,
            editable: true,
            visible: false,
            deleted: false,
            link: null,
            placeholder: null,
            hint: null,
            field_options: {
              unique: false,
            },
            searchable: true,
            parent_id: null,
            choices: [],
            custom: true,
          },
          {
            id: '8df0849d-f09a-448b-b697-b3fc864fb133',
            name: 'priority',
            column_name: 'priority',
            label: 'Priority',
            type: 2,
            field_options: {
              option_value_path: 'id',
              option_label_path: 'value',
            },
            custom: false,
            editable: true,
            position: 52,
            deleted: false,
            required: false,
            visible: true,
            column_type_blob: false,
            nodegroup_skip: false,
            validatable: false,
            builder: false,
            internal: false,
            choices: [
              {
                id: '1',
                account_id: '0',
                internal_name: 'low',
                value: 'Low',
                field_id: '8df0849d-f09a-448b-b697-b3fc864fb133',
                position: 1,
              },
              {
                id: '2',
                account_id: '0',
                internal_name: 'medium',
                value: 'Medium',
                field_id: '8df0849d-f09a-448b-b697-b3fc864fb133',
                position: 2,
              },
              {
                id: '3',
                account_id: '0',
                internal_name: 'high',
                value: 'High',
                field_id: '8df0849d-f09a-448b-b697-b3fc864fb133',
                position: 3,
              },
              {
                id: '4',
                account_id: '0',
                internal_name: 'urgent',
                value: 'Urgent',
                field_id: '8df0849d-f09a-448b-b697-b3fc864fb133',
                position: 4,
              },
            ],
            fields: [],
            regex: {},
            default_value: '1',
            created_at: '2023-03-14 13:20:09',
            updated_at: '2023-03-14 13:20:09',
          },
          {
            id: '7fdc76ec-a855-495d-a935-9bfa4fa8f834',
            name: 'cf_type',
            column_name: 'cf_bigint011',
            label: 'Type',
            type: 2,
            field_options: {
              has_sections: true,
            },
            choices: [
              {
                id: '58b9bf66-accb-450a-86ff-e8598827665c',
                value: 'order',
                field_id: '7fdc76ec-a855-495d-a935-9bfa4fa8f834',
                choice_options: {
                  section_name: 'orderSection',
                },
                dependent_ids: {
                  field: [
                    '67c99d97-8a54-4805-b416-a676f714ff1b',
                    'b3d6cf5e-7090-4503-a42a-51e460c0adcb',
                  ],
                  choice: [],
                },
              },
              {
                id: '5d5ca7c2-dd8a-4efa-8122-6beef9d6ce0f',
                value: 'refund',
                field_id: '7fdc76ec-a855-495d-a935-9bfa4fa8f834',
                choice_options: {
                  section_name: 'orderSection1',
                },
                dependent_ids: {
                  field: [],
                  choice: [],
                },
              },
              {
                id: '5d5ca7c2-dd8a-4efa-8122-6beef78hce0f',
                field_id: '7fdc76ec-a855-495d-a935-9bfa4fa8f834',
                value: 'cancel',
              },
            ],
            fields: [
              {
                id: '67c99d97-8a54-4805-b416-a676f714ff1b',
                parent_id: '7fdc76ec-a855-495d-a935-9bfa4fa8f834',
                name: 'cf_orderid',
                column_name: 'cf_str023',
                label: 'orderid',
                type: 1,
                field_options: {
                  is_section_field: true,
                },
                custom: true,
                editable: true,
                position: 114,
                deleted: false,
                required: true,
                visible: true,
                column_type_blob: false,
                nodegroup_skip: false,
                validatable: false,
                builder: false,
                internal: false,
                choices: [],
                fields: [],
                regex: {},
                created_at: '2024-07-11 10:49:48',
                updated_at: '2024-07-11 11:06:33',
              },
              {
                id: 'b3d6cf5e-7090-4503-a42a-51e460c0adcb',
                parent_id: '7fdc76ec-a855-495d-a935-9bfa4fa8f834',
                name: 'cf_orderstatus',
                column_name: 'cf_str023',
                label: 'orderstatus',
                type: 1,
                field_options: {
                  is_section_field: true,
                },
                custom: true,
                editable: true,
                position: 114,
                deleted: false,
                required: true,
                visible: true,
                column_type_blob: false,
                nodegroup_skip: false,
                validatable: false,
                builder: false,
                internal: false,
                choices: [],
                fields: [],
                regex: {},
                created_at: '2024-07-11 10:49:48',
                updated_at: '2024-07-11 11:06:33',
              },
            ],
            regex: {},
            created_at: '2024-06-10 09:00:42',
            updated_at: '2024-07-11 11:11:30',
          },
        ],
      };

      //       var formValuesConvProps = {
      //     "docId": "34812d27-6455-4eb4-8654-cd2c4cd0ed5d",
      //     "form_id": "0",
      //     "bundle_id": [
      //         "555741949072343098"
      //     ],
      //     "coll_id": "ConversationForm",
      //     "prod_id": "freshchat",
      //     "organisation_id": "555741948833267800",
      //     "name": "Conversation Form",
      //     "account_id": "721079537498489",
      //     "title": "Conversation Form",
      //     "description": "This is a conversation form",
      //     "deleted": false,
      //     "active": true,
      //     "compressed": false,
      //     "form_options": {
      //         "unique_attributes": "name, column_name, label"
      //     },
      //     "version": 46,
      //     "fields": [
      //         {
      //             "id": "0395c89a-ff56-49a0-a393-79bf48d8b65c",
      //             "name": "group",
      //             "column_name": "group",
      //             "label": "Group",
      //             "type": 2,
      //             "field_options": {
      //                 "reference": "true",
      //                 "option_value_path": "id",
      //                 "option_label_path": "value"
      //             },
      //             "custom": false,
      //             "editable": true,
      //             "position": 49,
      //             "deleted": false,
      //             "required": false,
      //             "visible": true,
      //             "column_type_blob": false,
      //             "nodegroup_skip": false,
      //             "validatable": false,
      //             "builder": false,
      //             "internal": false,
      //             "choices": [],
      //             "fields": [],
      //             "regex": {},
      //             "created_at": "2023-03-14 13:20:09",
      //             "updated_at": "2023-03-14 13:20:09"
      //         },
      //         {
      //             "id": "4747b941-a2cf-45ef-9118-d4007826fa92",
      //             "name": "agent",
      //             "column_name": "agent",
      //             "label": "Agent",
      //             "type": 2,
      //             "field_options": {
      //                 "reference": "true",
      //                 "option_value_path": "id",
      //                 "option_label_path": "value"
      //             },
      //             "custom": false,
      //             "editable": true,
      //             "position": 50,
      //             "deleted": false,
      //             "required": false,
      //             "visible": true,
      //             "column_type_blob": false,
      //             "nodegroup_skip": false,
      //             "validatable": false,
      //             "builder": false,
      //             "internal": false,
      //             "choices": [],
      //             "fields": [],
      //             "regex": {},
      //             "created_at": "2023-03-14 13:20:09",
      //             "updated_at": "2023-03-14 13:20:09"
      //         },
      //         {
      //             "id": "e189019d-ac50-4852-a17f-97acf2b05582",
      //             "name": "status",
      //             "column_name": "status",
      //             "label": "Status",
      //             "type": 2,
      //             "field_options": {
      //                 "option_value_path": "id",
      //                 "option_label_path": "value"
      //             },
      //             "custom": false,
      //             "editable": true,
      //             "position": 51,
      //             "deleted": false,
      //             "required": false,
      //             "visible": true,
      //             "column_type_blob": false,
      //             "nodegroup_skip": false,
      //             "validatable": false,
      //             "builder": false,
      //             "internal": false,
      //             "choices": [
      //                 {
      //                     "id": "0",
      //                     "account_id": "0",
      //                     "internal_name": "open",
      //                     "value": "Open",
      //                     "field_id": "e189019d-ac50-4852-a17f-97acf2b05582",
      //                     "position": 1
      //                 },
      //                 {
      //                     "id": "5",
      //                     "account_id": "0",
      //                     "internal_name": "waiting_on_customer",
      //                     "value": "Waiting on customer",
      //                     "field_id": "e189019d-ac50-4852-a17f-97acf2b05582",
      //                     "position": 2
      //                 },
      //                 {
      //                     "id": "6",
      //                     "account_id": "0",
      //                     "internal_name": "waiting_on_internal_teams",
      //                     "value": "Waiting on internal teams",
      //                     "field_id": "e189019d-ac50-4852-a17f-97acf2b05582",
      //                     "position": 3
      //                 },
      //                 {
      //                     "id": "2",
      //                     "account_id": "0",
      //                     "internal_name": "resolved",
      //                     "value": "Resolved",
      //                     "field_id": "e189019d-ac50-4852-a17f-97acf2b05582",
      //                     "position": 4
      //                 }
      //             ],
      //             "fields": [],
      //             "regex": {},
      //             "default_value": "0",
      //             "created_at": "2023-03-14 13:20:09",
      //             "updated_at": "2023-03-14 13:20:09"
      //         },
      //         {
      //             "id": "8df0849d-f09a-448b-b697-b3fc864fb133",
      //             "name": "priority",
      //             "column_name": "priority",
      //             "label": "Priority",
      //             "type": 2,
      //             "field_options": {
      //                 "option_value_path": "id",
      //                 "option_label_path": "value"
      //             },
      //             "custom": false,
      //             "editable": true,
      //             "position": 52,
      //             "deleted": false,
      //             "required": false,
      //             "visible": true,
      //             "column_type_blob": false,
      //             "nodegroup_skip": false,
      //             "validatable": false,
      //             "builder": false,
      //             "internal": false,
      //             "choices": [
      //                 {
      //                     "id": "1",
      //                     "account_id": "0",
      //                     "internal_name": "low",
      //                     "value": "Low",
      //                     "field_id": "8df0849d-f09a-448b-b697-b3fc864fb133",
      //                     "position": 1
      //                 },
      //                 {
      //                     "id": "2",
      //                     "account_id": "0",
      //                     "internal_name": "medium",
      //                     "value": "Medium",
      //                     "field_id": "8df0849d-f09a-448b-b697-b3fc864fb133",
      //                     "position": 2
      //                 },
      //                 {
      //                     "id": "3",
      //                     "account_id": "0",
      //                     "internal_name": "high",
      //                     "value": "High",
      //                     "field_id": "8df0849d-f09a-448b-b697-b3fc864fb133",
      //                     "position": 3
      //                 },
      //                 {
      //                     "id": "4",
      //                     "account_id": "0",
      //                     "internal_name": "urgent",
      //                     "value": "Urgent",
      //                     "field_id": "8df0849d-f09a-448b-b697-b3fc864fb133",
      //                     "position": 4
      //                 }
      //             ],
      //             "fields": [],
      //             "regex": {},
      //             "default_value": "1",
      //             "created_at": "2023-03-14 13:20:09",
      //             "updated_at": "2023-03-14 13:20:09"
      //         },
      //         {
      //             "id": "7fdc76ec-a855-495d-a935-9bfa4fa8f834",
      //             "name": "cf_type",
      //             "column_name": "cf_bigint011",
      //             "label": "Type",
      //             "type": 2,
      //             "field_options": {
      //                 "has_sections": true
      //             },
      //             "choices": [
      //                 {
      //                     "id": "58b9bf66-accb-450a-86ff-e8598827665c",
      //                     "value": "order",
      //                     "field_id": "7fdc76ec-a855-495d-a935-9bfa4fa8f834",
      //                     "choice_options": {
      //                         "section_name": "orderSection"
      //                     },
      //                     "dependent_ids": {
      //                         "field": [
      //                             "410a9452-70f4-4519-8b68-2bf0157ad46b",
      //                             "67c99d97-8a54-4805-b416-a676f714ff1b",
      //                             "b3d6cf5e-7090-4503-a42a-51e460c0adcb"
      //                         ],
      //                         "choice": []
      //                     }
      //                 },
      //                 {
      //                     "id": "5d5ca7c2-dd8a-4efa-8122-6beef9d6ce0f",
      //                     "value": "refund",
      //                     "field_id": "7fdc76ec-a855-495d-a935-9bfa4fa8f834",
      //                     "choice_options": {
      //                         "section_name": "orderSection1"
      //                     },
      //                     "dependent_ids": {
      //                         "field": [],
      //                         "choice": []
      //                     }
      //                 },
      //                 {
      //                     "id": "5d5ca7c2-dd8a-4efa-8122-6beef78hce0f",
      //                     "field_id": "7fdc76ec-a855-495d-a935-9bfa4fa8f834",
      //                     "value": "cancel"
      //                 }
      //             ],
      //             "fields": [
      //                 {
      //                     "id": "410a9452-70f4-4519-8b68-2bf0157ad46b",
      //                     "name": "testadd",
      //                     "label": "test_add",
      //                     "type": 1,
      //                     "required": false,
      //                     "filterable": false,
      //                     "editable": true,
      //                     "visible": false,
      //                     "deleted": false,
      //                     "link": null,
      //                     "placeholder": null,
      //                     "hint": null,
      //                     "field_options": {
      //                         "unique": false
      //                     },
      //                     "searchable": true,
      //                     "parent_id": null,
      //                     "choices": [],
      //                     "custom": true
      //                 },
      //                 {
      //                     "id": "67c99d97-8a54-4805-b416-a676f714ff1b",
      //                     "parent_id": "7fdc76ec-a855-495d-a935-9bfa4fa8f834",
      //                     "name": "cf_orderid",
      //                     "column_name": "cf_str023",
      //                     "label": "orderid",
      //                     "type": 1,
      //                     "field_options": {
      //                         "is_section_field": true
      //                     },
      //                     "custom": true,
      //                     "editable": true,
      //                     "position": 114,
      //                     "deleted": false,
      //                     "required": true,
      //                     "visible": true,
      //                     "column_type_blob": false,
      //                     "nodegroup_skip": false,
      //                     "validatable": false,
      //                     "builder": false,
      //                     "internal": false,
      //                     "choices": [],
      //                     "fields": [],
      //                     "regex": {},
      //                     "created_at": "2024-07-11 10:49:48",
      //                     "updated_at": "2024-07-11 11:06:33"
      //                 },
      //                 {
      //                     "id": "b3d6cf5e-7090-4503-a42a-51e460c0adcb",
      //                     "parent_id": "7fdc76ec-a855-495d-a935-9bfa4fa8f834",
      //                     "name": "cf_orderstatus",
      //                     "column_name": "cf_str023",
      //                     "label": "orderstatus",
      //                     "type": 1,
      //                     "field_options": {
      //                         "is_section_field": true
      //                     },
      //                     "custom": true,
      //                     "editable": true,
      //                     "position": 114,
      //                     "deleted": false,
      //                     "required": true,
      //                     "visible": true,
      //                     "column_type_blob": false,
      //                     "nodegroup_skip": false,
      //                     "validatable": false,
      //                     "builder": false,
      //                     "internal": false,
      //                     "choices": [],
      //                     "fields": [],
      //                     "regex": {},
      //                     "created_at": "2024-07-11 10:49:48",
      //                     "updated_at": "2024-07-11 11:06:33"
      //                 }
      //             ],
      //             "regex": {},
      //             "created_at": "2024-06-10 09:00:42",
      //             "updated_at": "2024-07-11 11:11:30"
      //         }
      //     ]
      // }

      var fb = document.getElementById('formBuilder');
      fb.productName = productName;
      fb.formValues = formValuesConvProps;
      fb.hideDependentCheckbox = true;
      fb.lookupTargetObjects = lookupTargets;
      // fb.formValues = formValues;
      // fb.role = 'trial';
      // fb.permission = { view: true, create: true, delete: true, edit: true };

      function create_UUID() {
        var dt = new Date().getTime();
        var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(
          /[xy]/g,
          function (c) {
            var r = (dt + Math.random() * 16) % 16 | 0;
            dt = Math.floor(dt / 16);
            return (c == 'x' ? r : (r & 0x3) | 0x8).toString(16);
          }
        );
        return uuid;
      }

      function getFormValues() {
        if (productName === 'CONVERSATION_PROPERTIES') {
          return formValuesConvProps;
        }
        return formValues;
      }

      function setFormValues(value) {
        if (productName === 'CONVERSATION_PROPERTIES') {
          // for Dependent fields
          formValuesConvProps = value;
          return;
        }
        formValues = value;
      }

      fb.addEventListener('fwComposeNewField', (event) => {
        var objDetail = event.detail;
        var intAddedIndex = -1;
        var objFormValues = getFormValues();
        var arrFields = objFormValues.fields;
        var intIndex = objDetail.index;
        var objDefaultField = objDetail.fieldSchema;
        objDefaultField.isNew = true;
        objDefaultField.id = 'new-field';
        if (
          arrFields.length === 0 ||
          intIndex < 0 ||
          intIndex > arrFields.length
        ) {
          arrFields = [...arrFields, objDefaultField];
          intAddedIndex = arrFields.length - 1;
        } else {
          if (objDetail?.sectionSource?.data?.field_options?.has_sections) {
            let foundObject = arrFields.find(
              (item) => item.id === objDetail?.sectionSource?.data.id
            );
            if (foundObject) {
              objDefaultField.sectionDetails = deepCloneObject(foundObject); //To add the fields for section
              objDefaultField.isSection = true;
              objDefaultField.sectionName = objDetail?.sectionSource?.name;
              foundObject?.choices?.forEach((choice) => {
                // Check if the section name matches
                if (
                  choice.choice_options?.section_name ===
                  objDetail?.sectionSource?.name
                ) {
                  choice?.dependent_ids?.field.splice(
                    intIndex,
                    0,
                    objDefaultField.id
                  );
                }
              });
              foundObject?.fields.splice(intIndex, 0, objDefaultField);
              intAddedIndex = intIndex;
            }
          } else {
            arrFields = [
              ...arrFields.slice(0, intIndex),
              objDefaultField,
              ...arrFields.slice(intIndex),
            ];
            intAddedIndex = intIndex;
          }
        }
        if (intAddedIndex !== -1) {
          var objFormValues = getFormValues();
          objFormValues = { ...objFormValues, fields: arrFields };
          setFormValues(objFormValues);
          fb.formValues = objFormValues;
          if (objDefaultField.isSection) {
            fb.expandedFieldIndex[
              `${objDetail?.sectionSource?.name}-${objDefaultField.id}`
            ] = intAddedIndex;
          } else {
            fb.expandedFieldIndex[objDefaultField.id] = intAddedIndex;
          }
          // fb.expandedFieldIndex[objDefaultField.id] = intAddedIndex;
          // fb.expandedFieldIndex= intAddedIndex;
        }
      });

      deleteNewLocalFieldAtIndex = (intIndex, objDetail) => {
        var objFormValues = getFormValues();
        var arrFields = objFormValues.fields;
        if (
          arrFields?.length > 0 &&
          intIndex < arrFields.length &&
          arrFields[intIndex]?.isNew === true
        ) {
          arrFields = [
            ...arrFields.slice(0, intIndex),
            ...arrFields.slice(intIndex + 1),
          ];
        } else {
          arrFields.forEach((field) => {
            if (field.field_options?.has_sections) {
              field.choices?.forEach((choice) => {
                if (choice.dependent_ids?.field) {
                  const indexInDependent = choice.dependent_ids.field.indexOf(
                    objDetail.value?.id
                  );
                  if (indexInDependent > -1) {
                    choice.dependent_ids.field.splice(indexInDependent, 1);
                  }
                }
              });
              const fieldIndex = field.fields.findIndex(
                (field) => field.id === objDetail.value?.id
              );

              // If the field is found, remove it from the fields array
              if (fieldIndex !== -1) {
                field.fields.splice(fieldIndex, 1);
              }
            }
          });
        }
        objFormValues = { ...objFormValues, fields: arrFields };
        setFormValues(objFormValues);
        fb.formValues = objFormValues;
      };

      fb.addEventListener('fwExpandField', (event) => {
        var objDetail = event.detail;
        var intIndex = objDetail.index;
        var boolExpanded = objDetail.expanded;
        if (boolExpanded) {
          let boolRefObj = {};
          let expandId = objDetail.sectionName
            ? `${objDetail.sectionName}-${objDetail.value?.id}`
            : objDetail.value?.id;
          boolRefObj[expandId] = intIndex;
          fb.expandedFieldIndex = boolRefObj;
        } else {
          fb.expandedFieldIndex = {};
        }
        // fb.expandedFieldIndex = boolExpanded ? intIndex : -1;
        if (!boolExpanded && objDetail.isNew && intIndex > -1) {
          deleteNewLocalFieldAtIndex(intIndex, objDetail);
        }
      });

      fb.addEventListener('fwDeleteField', (event) => {
        fb.loading = true;
        var objFormValues = getFormValues();
        var arrFields = objFormValues.fields;
        arrFields.splice(event.detail.index, 1);

        objFormValues = { ...objFormValues, fields: arrFields };
        setFormValues(objFormValues);
        fb.formValues = objFormValues;

        fb.loading = false;
      });

      // delete local field which was added if there are no fields present
      deleteNewFieldFromPayload = (arrFields) => {
        try {
          const intNewFieldIndex = arrFields.findIndex(
            (e) => e.id === 'new-field' && e.isNew === true
          );
          if (intNewFieldIndex > -1) {
            arrFields.splice(intNewFieldIndex, 1);
          }
        } catch (error) {}
      };

      fb.addEventListener('fwSaveField', (event) => {
        var objDetail = event.detail;
        var objFormValues = getFormValues();
        var arrFields = objFormValues.fields;
        if(objDetail.editSection) {
          const { value, selectedFieldValue, previousSelectedValue, sectionName } = objDetail;
          const fieldIndex = arrFields.findIndex((arrField) => {
            return value.id === arrField.id;
          });
          arrFields[fieldIndex].field_options = { has_sections: true };
          const choiceIndex = arrFields[fieldIndex].choices.findIndex( // Selected choice index
            (choice) => choice.value === selectedFieldValue
          );
          arrFields[fieldIndex].choices[choiceIndex].choice_options = {  // Update section name
            section_name: sectionName,
          };
          if(previousSelectedValue !== selectedFieldValue) { // When choice is updated
            const previouslySelectedchoiceIndex = arrFields[fieldIndex].choices.findIndex(
            (choice) => choice.value === previousSelectedValue
            );
            arrFields[fieldIndex].choices[previouslySelectedchoiceIndex].choice_options = {
              section_name: '',
            };
            arrFields[fieldIndex].choices[choiceIndex].dependent_ids = arrFields[fieldIndex].choices[previouslySelectedchoiceIndex].dependent_ids;
            arrFields[fieldIndex].choices[previouslySelectedchoiceIndex].dependent_ids = [
              { field: [], choice: [] },
            ];
          }

          objFormValues = { ...objFormValues, fields: arrFields };
          fb.expandedFieldIndex = {};
          setFormValues(objFormValues);
          fb.formValues = objFormValues;
        }

        if (objDetail.sectionCreation) {
          const { value, selectedFieldValue, sectionName } = objDetail;
          const fieldIndex = arrFields.findIndex((arrField) => {
            return value.id === arrField.id;
          });
          arrFields[fieldIndex].field_options = { has_sections: true };
          const choiceIndex = arrFields[fieldIndex].choices.findIndex(
            (choice) => choice.value === selectedFieldValue
          );
          arrFields[fieldIndex].choices[choiceIndex].choice_options = {
            section_name: sectionName,
          };
          arrFields[fieldIndex].choices[choiceIndex].dependent_ids = [
            { field: [], choice: [] },
          ];
          objFormValues = { ...objFormValues, fields: arrFields };
          fb.expandedFieldIndex = {};
          setFormValues(objFormValues);
          fb.formValues = objFormValues;
          return;
        }

        fb.loading = true;

        var objSubmitFormValues =
          objDetail.value.type === 22
            ? objDetail.value.fields[0]
            : objDetail.value;
        var boolNewField = objDetail.isNew;
        var intIndex = Object.prototype.hasOwnProperty.call(objDetail, 'index')
          ? objDetail.index
          : -1;
        var intAddedIndex = intIndex;
        var isPrimaryField = !!(
          Object.prototype.hasOwnProperty.call(
            objSubmitFormValues,
            'isPrimaryField'
          ) && objSubmitFormValues.isPrimaryField === true
        );
        var strFieldLabel = objSubmitFormValues.name;
        var strFieldType = !isPrimaryField
          ? objSubmitFormValues.type
          : 'PRIMARY';
        var boolFilterable = Object.prototype.hasOwnProperty.call(
          objSubmitFormValues,
          'filterable'
        )
          ? objSubmitFormValues.filterable
          : false;
        var boolUnique = Object.prototype.hasOwnProperty.call(
          objSubmitFormValues,
          'unique'
        )
          ? objSubmitFormValues.unique
          : false;
        var arrChoices =
          Object.prototype.hasOwnProperty.call(
            objSubmitFormValues,
            'choices'
          ) &&
          objSubmitFormValues.choices &&
          objSubmitFormValues.choices.length > 0
            ? [...objSubmitFormValues.choices]
            : [];

        var strRemovedSpecialChars = strFieldLabel.replace(
          /[^a-zA-Z0-9 ]/g,
          ''
        );

        var strGeneratedFieldName = strRemovedSpecialChars
          .split(' ')
          .join('_')
          .toLowerCase();

        var fields = objSubmitFormValues?.fields?.length
          ? objSubmitFormValues.fields
          : [];

        // make the api call to save the new/edited field data in the DB
        // Temp - updating local field
        var objUpdatedField = null;
        deleteNewFieldFromPayload(arrFields);

        if (boolNewField) {
          objUpdatedField = {
            id: '',
            name: '',
            label: '',
            type: '',
            required: false,
            filterable: false,
            editable: true,
            visible: false,
            deleted: false,
            link: null,
            placeholder: null,
            hint: null,
            field_options: { unique: false },
            searchable: true,
            parent_id: null,
            choices: [],
          };
          if (strFieldType === 'DECIMAL') {
            objUpdatedField.searchable = false;
          }
          // Name and ID Needs to be generated at the backend
          if (!objUpdatedField.name || objUpdatedField.name === '') {
            objUpdatedField.name = strGeneratedFieldName;
          }
          objUpdatedField.id = create_UUID();

          if (productName === 'CONVERSATION_PROPERTIES') {
            objUpdatedField.custom = true;
          }
        } else {
          if (
            arrFields &&
            intAddedIndex >= 0 &&
            intAddedIndex < arrFields.length
          ) {
            objUpdatedField = arrFields[intAddedIndex];
          } else {
            console.error('Field not found in entity object..');
            return null;
          }
        }

        var boolUpdateUniqueValue = true;
        if (strFieldType === 'RELATIONSHIP') {
          // update lookup relationship data if its a new Field
          if (boolNewField) {
            var objRelationshipValues = objSubmitFormValues.relationship;
            var objRelatedEntity = {
              isNative: false,
              text: objRelationshipValues.target, // display name of the related entity
              value: 1, // id of the related entity
            };
            objUpdatedField.related_entity_id = objRelatedEntity.id;
            objUpdatedField.relationship_name = strGeneratedFieldName; // needs to be unique within the entity
            objUpdatedField.child_relationship_name = `${strGeneratedFieldName}_${new Date().getTime()}`; // needs to be unique within the entity
            objUpdatedField.field_options.unique =
              objRelationshipValues.relationship === 'one_to_one';
          }
          boolUpdateUniqueValue = false;
        }

        if (fields.length) {
          objUpdatedField.fields = fields;
          objUpdatedField.field_options = {
            ...objUpdatedField.field_options,
            ...objSubmitFormValues.field_options,
          };
        }

        function addLabel(data, label) {
          if (!data.label) {
            data.label = label;
          }

          if (data.fields && data.fields.length) {
            addLabel(data.fields[0], data.fields[0].name);
          }
        }

        addLabel(objUpdatedField, strFieldLabel);

        objUpdatedField.type = strFieldType;
        objUpdatedField.required = objSubmitFormValues.required;
        objUpdatedField.filterable = boolFilterable;
        objUpdatedField.choices = arrChoices;
        if (boolUpdateUniqueValue) {
          objUpdatedField.field_options.unique = boolUnique;
        }

        if (boolNewField) {
          // validate if the array is empty or the passed index is invalid - if true -push the element at the end of the array
          if (
            arrFields.length === 0 ||
            intIndex < 0 ||
            intIndex > arrFields.length
          ) {
            arrFields = [...arrFields, objUpdatedField];
            intAddedIndex = arrFields.length - 1;
          } else {
            // store the element at the passed index
            if (objDetail?.value?.newSectionData?.isSection) {
              objUpdatedField.field_options.is_section_field = true;
              let foundObject = arrFields.find(
                (item) =>
                  item.id ===
                  objDetail?.value?.newSectionData?.sectionDetails?.id
              );

              if (foundObject) {
                foundObject?.choices?.forEach((choice) => {
                  if (
                    choice.choice_options?.section_name ===
                    objDetail?.value?.newSectionData?.sectionName
                  ) {
                    choice?.dependent_ids?.field.splice(
                      intIndex,
                      1,
                      objUpdatedField.id
                    );
                  }
                });
                foundObject.fields = [
                  ...foundObject.fields.slice(0, intIndex),
                  objUpdatedField,
                  ...foundObject.fields.slice(intIndex + 1),
                ];
                intAddedIndex = intIndex;
              }
            } else {
              arrFields = [
                ...arrFields.slice(0, intIndex),
                objUpdatedField,
                ...arrFields.slice(intIndex),
              ];
              intAddedIndex = intIndex;
            }
          }
        }

        fb.expandedFieldIndex = {};
        // fb.expandedFieldIndex = -1;

        objFormValues = { ...objFormValues, fields: arrFields };
        setFormValues(objFormValues);
        fb.formValues = objFormValues;

        fb.loading = false;
      });

      function deepCloneObject(objSource) {
        try {
          return JSON.parse(JSON.stringify(objSource));
        } catch (error) {
          console.log('error deep cloning object - ' + error);
          return {};
        }
      }

      // Function to find section names based on source field ID and section name
      function findSectionNames(foundObject, sourceFieldId, sectionName) {
        let sourceSectionName, targetSectionName;

        foundObject.choices?.forEach((choice) => {
          if (choice.dependent_ids?.field.includes(sourceFieldId)) {
            sourceSectionName = choice.choice_options?.section_name;
          }
          if (choice.choice_options?.section_name === sectionName) {
            targetSectionName = choice.choice_options?.section_name;
          }
        });

        return { sourceSectionName, targetSectionName };
      }

      // Function to move a field between sections or within a section
      function moveFieldBetweenSections(
        foundObject,
        sourceSectionName,
        targetSectionName,
        intSourceIndex,
        intTargetIndex,
        arrFields
      ) {
        let movedFieldId;

        foundObject.choices?.forEach((choice) => {
          let arrSectionFields = choice?.dependent_ids?.field;

          if (choice.choice_options?.section_name === sourceSectionName) {
            // Remove from source section
            movedFieldId = arrSectionFields.splice(intSourceIndex, 1)[0];

            if (sourceSectionName === targetSectionName) {
              // Reposition within the same section
              arrSectionFields.splice(intTargetIndex, 0, movedFieldId);
            } else if (targetSectionName) {
              // Add to target section
              let targetSectionFields = foundObject.choices.find(
                (c) => c.choice_options?.section_name === targetSectionName
              )?.dependent_ids?.field;
              targetSectionFields.splice(intTargetIndex, 0, movedFieldId);
            }
          }
        });

        return movedFieldId;
      }

      // Function to handle field repositioning
      function handleFieldRepositioning(
        objDetail,
        intSourceIndex,
        intTargetIndex,
        arrFields
      ) {
        let objFormValues = getFormValues();
        let foundObject = arrFields.find(
          (item) => item.id === objDetail?.sectionData?.data.id
        );

        if (foundObject) {
          const { sourceSectionName, targetSectionName } = findSectionNames(
            foundObject,
            objDetail.sourceFieldId,
            objDetail?.sectionData?.name
          );

          if (!sourceSectionName && targetSectionName) {
            // Dragged from outside to inside a section
            const objFieldOut = arrFields.splice(intSourceIndex, 1)[0]; // Remove the field from arrFields

            foundObject.choices?.forEach((choice) => {
              if (choice.choice_options?.section_name === targetSectionName) {
                // Add the field ID to the target section's dependent_ids array
                choice.dependent_ids?.field.splice(
                  intTargetIndex,
                  0,
                  objFieldOut.id
                );
              }
            });

            objFieldOut.field_options.is_section_field = true;
            objFieldOut.parent_id = foundObject.id;

            // Add the field object to the target section's fields array
            foundObject.fields.splice(intTargetIndex, 0, objFieldOut);
          } else if (sourceSectionName && !targetSectionName) {
            // Dragged from inside a section to outside
            const movedFieldId = moveFieldBetweenSections(
              foundObject,
              sourceSectionName,
              targetSectionName,
              intSourceIndex,
              intTargetIndex,
              arrFields
            );

            // Add the field object back to the main arrFields array
            const objFieldInSection = foundObject.fields.find(
              (field) => field.id === movedFieldId
            );
            if (objFieldInSection) {
              foundObject.fields.splice(
                foundObject.fields.indexOf(objFieldInSection),
                1
              ); // Remove from the section's fields array
              objFieldInSection.field_options.is_section_field = false;
              delete objFieldInSection.parent_id;
              arrFields.splice(intTargetIndex, 0, objFieldInSection); // Add to the main fields array
            }
          } else if (sourceSectionName && targetSectionName) {
            moveFieldBetweenSections(
              foundObject,
              sourceSectionName,
              targetSectionName,
              intSourceIndex,
              intTargetIndex,
              arrFields
            );
          }
        } else {
          const objField = arrFields.splice(intSourceIndex, 1)[0];
          arrFields.splice(intTargetIndex, 0, objField);
        }

        return objFormValues;
      }

      // Event listener for repositioning fields
      fb.addEventListener('fwRepositionField', (event) => {
        var objDetail = event.detail;
        var intSourceIndex = objDetail.sourceIndex;
        var intTargetIndex = objDetail.targetIndex;

        if (
          intSourceIndex === intTargetIndex &&
          !objDetail?.isRepositionSection
        ) {
          return;
        }

        var objPrePositionSource = deepCloneObject(getFormValues());

        try {
          var arrFields = getFormValues().fields;
          var objFormValues = handleFieldRepositioning(
            objDetail,
            intSourceIndex,
            intTargetIndex,
            arrFields
          );

          objFormValues = { ...objFormValues };
          setFormValues(objFormValues);
          fb.formValues = objFormValues;
          // Uncomment the below lines if you need to reset the position
          // fb.formValues = objPrePositionSource;
          // fb.forceRenderFields();
        } catch (error) {
          console.error('Error in repositioning field ' + error);
        }
      });

      fb.addEventListener('fwSaveWidgetFields', (event) => {
        customizeWidgetFields = event.detail;
        fb.customizeWidgetFields = customizeWidgetFields;
        fb.isSavingCustomizeWidget = false;
      });

      tabProducts.addEventListener('fwChange', (event) => {
        const intTabIndex = event.detail.tabIndex;
        if (intTabIndex === 1 && productName !== 'CUSTOM_OBJECTS') {
          productName = 'CUSTOM_OBJECTS';
          fb.productName = productName;
          fb.formValues = formValues;
        } else if (
          intTabIndex === 0 &&
          productName !== 'CONVERSATION_PROPERTIES'
        ) {
          productName = 'CONVERSATION_PROPERTIES';
          fb.productName = productName;
          fb.formValues = formValuesConvProps;
        }
      });
    </script>
  </body>
</html>
